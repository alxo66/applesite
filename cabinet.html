<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî Apple Store</title>
    <link rel="stylesheet" href="style.css"> </head>
<body>

    <header class="header">
        <a href="index.html" class="logo">Apple Store</a>
        <nav>
            <a href="shop.html">–ú–∞–≥–∞–∑–∏–Ω</a>
            <a href="cabinet.html" class="active">–ö–∞–±–∏–Ω–µ—Ç</a>
            <a href="deposit.html">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
        </nav>
    </header>

    <div class="container" style="max-width: 800px;">
        <h1>–í–∞—à –∫–∞–±–∏–Ω–µ—Ç. <span>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–∫–∞–∑–∞–º–∏ –∏ –±–∞–ª–∞–Ω—Å–æ–º.</span></h1>

        <div class="stats">
            <div class="card">
                <h3>–î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</h3>
                <div class="value" id="balance">0 ‚ÇΩ</div>
            </div>
            <div class="card">
                <h3>–ó–∞–∫–∞–∑–æ–≤ —Å–¥–µ–ª–∞–Ω–æ</h3>
                <div class="value" id="orderCount">0</div>
            </div>
        </div>

        <div class="card">
            <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cartList">
                </div>
            
            <div id="cartSummary" style="margin-top: 25px; border-top: 1px solid #f5f5f7; pt: 20px; display: none;">
                <div class="total" id="totalPrice" style="font-size: 24px; margin-bottom: 20px; text-align: right;"></div>
                <div style="display: flex; gap: 15px;">
                    <button id="orderBtn" style="flex: 2;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                    <button id="clearBtn" class="danger" style="flex: 1; background: #f5f5f7; color: #ff3b30;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            <div id="history" style="font-size: 14px; color: #86868b;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
            </div>
        </div>
    </div>

    <script type="module">
        import { getCabinet, createOrder, getCart, clearCart } from './api.js';

        async function init() {
            const data = await getCabinet();
            const cart = getCart();

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            document.getElementById("balance").textContent = `${data.balance.toLocaleString()} ‚ÇΩ`;
            document.getElementById("orderCount").textContent = data.orders.length;

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
            renderCartUI(cart);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
            renderHistory(data.orders, data.deposits);
        }

        function renderCartUI(cart) {
            const root = document.getElementById("cartList");
            const summary = document.getElementById("cartSummary");
            const totalEl = document.getElementById("totalPrice");

            if (!cart.length) {
                root.innerHTML = `<p style="text-align: center; color: #86868b; padding: 20px;">–í–∞—à–∞ —Å—É–º–∫–∞ –ø—É—Å—Ç–∞.</p>`;
                summary.style.display = "none";
                return;
            }

            summary.style.display = "block";
            root.innerHTML = cart.map(item => `
                <div class="item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f5f5f7;">
                    <span>${item.title}</span>
                    <span style="font-weight: 600;">${item.price.toLocaleString()} ‚ÇΩ</span>
                </div>
            `).join("");

            const sum = cart.reduce((acc, item) => acc + item.price, 0);
            totalEl.textContent = `–ò—Ç–æ–≥–æ: ${sum.toLocaleString()} ‚ÇΩ`;
        }

        function renderHistory(orders, deposits) {
            const histEl = document.getElementById("history");
            if (!orders.length && !deposits.length) {
                histEl.textContent = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.";
                return;
            }
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            const historyHTML = orders.map(o => `
                <div style="margin-bottom: 8px; color: #1d1d1f;">
                    üõçÔ∏è –ó–∞–∫–∞–∑: ${o.title || '–¢–æ–≤–∞—Ä'} ‚Äî <span style="color: #0071e3;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                </div>
            `).join("");
            
            histEl.innerHTML = historyHTML;
        }

        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        document.getElementById("clearBtn").onclick = () => {
            clearCart();
            init();
        };

        // –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        document.getElementById("orderBtn").onclick = async () => {
            const cart = getCart();
            let successCount = 0;

            for (const item of cart) {
                const res = await createOrder(item);
                if (res.error) {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ ${item.title}: ${res.error}`);
                    break;
                }
                successCount++;
            }

            if (successCount === cart.length) {
                alert("–í—Å–µ –∑–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã!");
                clearCart();
                init();
            } else {
                init(); // –û–±–Ω–æ–≤–ª—è–µ–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
            }
        };

        init();
    </script>
</body>
</html>
