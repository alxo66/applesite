<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    
    <title>Apple Store | Premium Reseller</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="header">
    <div class="header-content">
        <a href="index.html" class="logo">Apple <span>Store</span></a>
        <nav class="main-nav">
            <a href="about.html">О компании</a>
            <a href="cabinet.html">Личный кабинет</a>
            <a href="shipping.html">Доставка</a>
        </nav>
    </div>
</header>

<div class="container">
    <h1>Магазин. <span>Лучшее от Apple.</span></h1>
    <div id="products" class="products">
        <div class="loader-container" style="grid-column: 1/-1; text-align: center; padding: 100px;">
            <p>Загрузка актуального ассортимента...</p>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-content">
        <p>Copyright © 2026 Apple Store. Все права защищены. Цены указаны в USDT.</p>
        <div class="support-link">
            Поддержка: <a href="https://t.me/crypto_applestore_bot" target="_blank">@crypto_applestore_bot</a>
        </div>
    </div>
</footer>

<script type="module">
    import { getProducts, createOrder } from './api.js';

    let allProductsData = []; 

    // Улучшенная функция выбора параметров с поддержкой SIM
    window.selectOption = (element, type, value, productId) => {
        const card = element.closest('.product');
        const product = allProductsData.find(p => p.id === productId);
        
        // 1. Переключаем визуальную активность
        const parent = element.parentElement;
        const selectorClass = type === 'color' ? '.color-dot' : (type === 'storage' ? '.storage-item' : '.sim-item');
        parent.querySelectorAll(selectorClass).forEach(item => item.classList.remove('active'));
        element.classList.add('active');

        // 2. Если выбрали цвет — меняем картинку
        if (type === 'color' && product.images) {
            const imgElement = card.querySelector('.img-container img');
            if (product.images[value]) {
                imgElement.src = product.images[value];
            }
        }

        // 3. Динамический пересчет цены (Память + SIM)
        const priceElement = card.querySelector('.price');
        
        const activeStorage = card.querySelector('.storage-item.active')?.innerText.trim();
        const activeSim = card.querySelector('.sim-item.active')?.innerText.trim();

        // Базовая цена от выбранной памяти
        let basePrice = product.storagePrices && activeStorage ? product.storagePrices[activeStorage] : product.price;
        
        // Наценка за SIM (если есть)
        let simMarkup = (product.simPrices && activeSim) ? product.simPrices[activeSim] : 0;

        const finalPrice = basePrice + simMarkup;
        priceElement.innerText = `${finalPrice.toLocaleString()} USDT`;
    };

    async function loadProducts() {
        const container = document.getElementById("products");
        try {
            const products = await getProducts();
            allProductsData = products; 

            if (!products || products.length === 0) {
                container.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">Товары временно отсутствуют.</p>`;
                return;
            }

            container.innerHTML = "";

            const categories = {
                "iPhone": products.filter(p => p.id.startsWith("i15") || p.id.startsWith("i16") || p.id.startsWith("i17")),
                "iPad": products.filter(p => p.id.includes("ipad")),
                "MacBook": products.filter(p => p.id.includes("mbp") || p.id.includes("mba"))
            };

            for (const [categoryName, items] of Object.entries(categories)) {
                if (items.length === 0) continue;

                const title = document.createElement("h2");
                title.className = "category-title reveal";
                title.innerText = categoryName;
                container.appendChild(title);

                items.forEach(p => {
                    const card = document.createElement("div");
                    card.className = "product reveal"; 
                    card.innerHTML = `
                        <div class="img-container">
                            <img src="${p.image}" alt="${p.title}" id="img-${p.id}" loading="lazy" 
                                 onerror="this.onerror=null;this.src='https://placehold.jp/24/0071e3/ffffff/300x300.png?text=Apple+Device';">
                        </div>
                        <div class="product-info">
                            <h3>${p.title}</h3>
                            <p>${p.description}</p>
                            
                            <ul class="specs-list">
                                ${p.specs ? p.specs.map(s => `<li>${s}</li>`).join('') : ''}
                            </ul>

                            ${p.colors ? `
                                <div class="color-selector">
                                    ${p.colors.map((color, index) => `
                                        <div class="color-dot ${index === 0 ? 'active' : ''}" 
                                             style="background-color: ${color}" 
                                             onclick="selectOption(this, 'color', '${color}', '${p.id}')">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            ${p.storage ? `
                                <div class="storage-selector">
                                    ${p.storage.map((size, index) => `
                                        <div class="storage-item ${index === 0 ? 'active' : ''}" 
                                             onclick="selectOption(this, 'storage', '${size}', '${p.id}')">
                                            ${size}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            ${p.sim ? `
                                <div class="sim-selector">
                                    ${p.sim.map((type, index) => `
                                        <div class="sim-item ${index === 0 ? 'active' : ''}" 
                                             onclick="selectOption(this, 'sim', '${type}', '${p.id}')">
                                            ${type}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div class="price">${p.price.toLocaleString()} USDT</div>
                            <button class="buy-btn" data-id="${p.id}">Купить</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

            document.querySelectorAll('.buy-btn').forEach(btn => {
                btn.onclick = () => {
                    const card = btn.closest('.product');
                    const productId = btn.dataset.id;
                    const product = allProductsData.find(p => p.id === productId);

                    const selectedColor = card.querySelector('.color-dot.active')?.style.backgroundColor;
                    const selectedStorage = card.querySelector('.storage-item.active')?.innerText.trim();
                    const selectedSim = card.querySelector('.sim-item.active')?.innerText.trim() || "N/A";
                    const currentPriceText = card.querySelector('.price').innerText;
                    const finalPrice = parseInt(currentPriceText.replace(/[^0-9]/g, ''));

                    buy(productId, allProductsData, { 
                        color: selectedColor, 
                        storage: selectedStorage,
                        sim: selectedSim,
                        price: finalPrice 
                    });
                };
            });

        } catch (err) {
            console.error("Ошибка:", err);
            container.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">Ошибка загрузки сервера.</p>`;
        }
    }

    async function buy(id, products, options) {
        const product = products.find(p => p.id === id);
        const btn = document.querySelector(`.buy-btn[data-id="${id}"]`);
        
        const orderData = { 
            productId: product.id,
            title: product.title,
            price: options.price, 
            selectedOptions: {
                color: options.color,
                storage: options.storage,
                sim: options.sim
            } 
        };
        
        const originalText = btn.innerText;
        btn.innerText = "Оформление...";
        btn.disabled = true;

        try {
            const res = await createOrder(orderData);
            if (res.success) {
                alert(`Заказ на ${product.title} успешно создан!`);
                window.location.href = "cabinet.html";
            } else {
                if (confirm("Недостаточно средств. Перейти к пополнению?")) {
                    window.location.href = "cabinet.html";
                }
            }
        } catch (err) {
            alert("Ошибка связи с сервером");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    loadProducts();
</script>
</body>
</html>
