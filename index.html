<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Apple Store | Premium Reseller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<header class="header">
    <a href="index.html" class="logo">Apple Store</a>
    <nav>
        <a href="index.html" class="active">Магазин</a>
        <a href="cabinet.html">Личный кабинет</a>
        <a href="shipping.html">Доставка</a>
    </nav>
</header>

<div class="container">
    <h1>Магазин. <span>Лучшее от Apple.</span></h1>
    
    <div id="products" class="products">
        <div style="text-align: center; grid-column: 1/-1; padding: 50px; opacity: 0.5;">
            Загрузка актуального ассортимента...
        </div>
    </div>
</div>

<footer>
    <p>Copyright © 2024 Apple Store. Все права защищены. Цены указаны в USDT.</p>
</footer>

<script type="module">
    // Импортируем функции из нашего api.js
    import { getProducts, createOrder } from './api.js';

    async function loadProducts() {
        const container = document.getElementById("products");
        const products = await getProducts();

        if (!products || products.length === 0) {
            container.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">Товары временно отсутствуют.</p>`;
            return;
        }

        // Очищаем индикатор загрузки
        container.innerHTML = "";

        // Группируем товары по категориям (iPhone, iPad, MacBook)
        const categories = {
            "iPhone": products.filter(p => p.title.includes("iPhone")),
            "iPad": products.filter(p => p.title.includes("iPad")),
            "MacBook": products.filter(p => p.title.includes("MacBook"))
        };

        // Рисуем товары по категориям
        for (const [categoryName, items] of Object.entries(categories)) {
            if (items.length === 0) continue;

            // Заголовок категории
            const title = document.createElement("h2");
            title.className = "category-title";
            title.style.gridColumn = "1 / -1"; 
            title.style.marginTop = "40px";
            title.innerText = categoryName;
            container.appendChild(title);

            // Карточки товаров
            items.forEach(p => {
                const card = document.createElement("div");
                card.className = "product";
                card.innerHTML = `
                    <img src="${p.image}" alt="${p.title}" onerror="this.src='https://via.placeholder.com/300x300?text=Apple+Device'">
                    <div class="product-info">
                        <h3>${p.title}</h3>
                        <p>${p.description}</p>
                        <ul class="specs-list">
                            ${p.specs ? p.specs.map(s => `<li>${s}</li>`).join('') : ''}
                        </ul>
                        <div class="price" style="font-weight: 600; font-size: 1.2rem; margin: 15px 0;">
                            ${p.price.toLocaleString()} USDT
                        </div>
                        <button class="buy-btn" data-id="${p.id}" style="width: 100%;">Купить</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Привязываем логику покупки к кнопкам
        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                await buy(id, products);
            });
        });
    }

    async function buy(id, products) {
        const product = products.find(p => p.id === id);
        if (!product) return;

        const btn = document.querySelector(`.buy-btn[data-id="${id}"]`);
        btn.innerText = "Оформление...";
        btn.disabled = true;

        try {
            const res = await createOrder(product);
            if (res.success) {
                alert("Заказ успешно создан!");
                window.location.href = "cabinet.html";
            } else {
                if (confirm("Недостаточно средств. Перейти в Личный кабинет для пополнения?")) {
                    window.location.href = "cabinet.html"; // Теперь пополнение внутри кабинета или отдельной ссылкой
                }
            }
        } catch (err) {
            alert("Ошибка связи с сервером");
        } finally {
            btn.innerText = "Купить";
            btn.disabled = false;
        }
    }

    loadProducts();
</script>

</body>
</html>
