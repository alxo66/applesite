<script type="module">
    import { getProducts, createOrder } from './api.js';

    async function loadProducts() {
        const products = await getProducts();
        const container = document.getElementById("products");

        if (!products || products.length === 0) {
            container.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">Товары временно отсутствуют.</p>`;
            return;
        }

        // Очищаем контейнер перед загрузкой
        container.innerHTML = "";

        // Группируем товары по типу для удобства навигации
        const categories = {
            "iPhone": products.filter(p => p.title.includes("iPhone")),
            "iPad": products.filter(p => p.title.includes("iPad")),
            "MacBook": products.filter(p => p.title.includes("MacBook"))
        };

        for (const [name, items] of Object.entries(categories)) {
            if (items.length === 0) continue;

            // Добавляем заголовок категории
            const title = document.createElement("h2");
            title.className = "category-title";
            title.style.gridColumn = "1 / -1"; // Растягиваем на всю ширину
            title.innerText = name;
            container.appendChild(title);

            // Отрисовываем карточки товаров
            items.forEach(p => {
                const card = document.createElement("div");
                card.className = "product";
                card.innerHTML = `
                    <img src="${p.image}" alt="${p.title}" onerror="this.src='https://via.placeholder.com/300x300?text=Apple+Device'">
                    <div class="product-info">
                        <h3>${p.title}</h3>
                        <p>${p.description}</p>
                        <ul class="specs-list">
                            ${p.specs ? p.specs.map(s => `<li>${s}</li>`).join('') : ''}
                        </ul>
                        <div class="price">${p.price.toLocaleString()} USDT</div>
                        <button class="buy-btn" data-id="${p.id}">Купить</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Вешаем события на кнопки
        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', () => buy(btn.getAttribute('data-id')));
        });
    }

    async function buy(id) {
        // Кэшируем список товаров для быстрого поиска
        const products = await getProducts(); 
        const product = products.find(p => p.id === id);
        
        if (!product) return alert("Товар не найден");

        const btn = document.querySelector(`.buy-btn[data-id="${id}"]`);
        const originalText = btn.innerText;
        btn.innerText = "Оформление...";
        btn.disabled = true;

        try {
            const res = await createOrder(product);
            if (res.success) {
                alert("Заказ успешно создан! Ожидайте доставку.");
                window.location.href = "cabinet.html";
            } else {
                // Если бэкенд вернул ошибку баланса
                if (confirm("Недостаточно USDT на балансе. Перейти к пополнению?")) {
                    window.location.href = "deposit.html";
                }
            }
        } catch (err) {
            console.error(err);
            alert("Ошибка при связи с сервером");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // Запуск при загрузке страницы
    loadProducts();
</script>
