<script type="module">
    import { getProducts, createOrder } from './api.js';

    async function loadProducts() {
        const products = await getProducts();
        const el = document.getElementById("products");

        if (!products || products.length === 0) {
            el.innerHTML = `<p style="grid-column: 1/-1; text-align: center;">Товары временно отсутствуют.</p>`;
            return;
        }

        el.innerHTML = products.map(p => `
            <div class="product">
                <img src="${p.image}" alt="${p.title}" onerror="this.src='https://via.placeholder.com/300x200?text=Apple+Device'">
                <div class="product-info">
                    <h3>${p.title}</h3>
                    <p>${p.description}</p>
                    <ul style="font-size: 12px; color: #86868b; list-style: none; padding: 0; margin: 10px 0;">
                        ${p.specs ? p.specs.map(s => `<li>• ${s}</li>`).join('') : ''}
                    </ul>
                    <div class="price" style="font-weight: bold; font-size: 1.2rem; margin: 10px 0;">
                        ${p.price.toLocaleString()} USDT
                    </div>
                    <button class="buy-btn" data-id="${p.id}" style="width: 100%; cursor: pointer;">Купить</button>
                </div>
            </div>
        `).join("");

        document.querySelectorAll('.buy-btn').forEach(btn => {
            btn.addEventListener('click', () => buy(btn.getAttribute('data-id')));
        });
    }

    async function buy(id) {
        // Не нужно грузить все товары снова, возьмем текущие из DOM или закэшируем
        const products = await getProducts(); 
        const product = products.find(p => p.id === id);
        
        if (!product) return alert("Товар не найден");

        // Показываем индикатор загрузки на кнопке
        const btn = document.querySelector(`.buy-btn[data-id="${id}"]`);
        const originalText = btn.innerText;
        btn.innerText = "Оформление...";
        btn.disabled = true;

        try {
            const res = await createOrder(product);
            if (res.success) {
                alert("Заказ успешно создан!");
                window.location.href = "cabinet.html";
            } else {
                if (confirm("Недостаточно средств на балансе. Перейти к пополнению?")) {
                    window.location.href = "deposit.html";
                }
            }
        } catch (err) {
            alert("Ошибка при создании заказа");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    loadProducts();
</script>
